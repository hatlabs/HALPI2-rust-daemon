#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands used during development / CI.
# Also, executable documentation for project dev practices.
#
# See https://death.andgravity.com/run-sh
# for an explanation of how it works and why it's useful.

################################################################################
# Core Development Commands

function build {
  #@ Build all workspace members (debug by default)
  #@ Usage: build [--release]
  #@ Category: Core Development
  cargo build $@
}

function build-daemon {
  #@ Build the halpid daemon
  #@ Usage: build-daemon [--release]
  #@ Category: Core Development
  cargo build -p halpid $@
}

function build-cli {
  #@ Build the halpi CLI
  #@ Usage: build-cli [--release]
  #@ Category: Core Development
  cargo build -p halpi $@
}

function clean {
  #@ Clean all build artifacts
  #@ Category: Core Development
  cargo clean $@
}

function check {
  #@ Run cargo check and clippy
  #@ Category: Core Development
  cargo check --all-targets
  cargo clippy --all-targets -- -D warnings
}

function format {
  #@ Format code with rustfmt
  #@ Category: Core Development
  cargo fmt --all
}

function check-format {
  #@ Check code formatting without making changes
  #@ Category: Core Development
  cargo fmt --all -- --check
}

################################################################################
# Cross-Compilation Commands

function cross-build {
  #@ Build for ARM64 Linux using cross
  #@ Usage: cross-build [--release]
  #@ Category: Cross-Compilation
  if ! command -v cross &> /dev/null; then
    echo "Error: 'cross' not found. Run './run setup-cross' first."
    exit 1
  fi

  cross build --target aarch64-unknown-linux-musl $@
}

function setup-cross {
  #@ Install cross-compilation tools
  #@ Category: Cross-Compilation
  cargo install cross
  echo "‚úÖ cross installed successfully"
}

################################################################################
# Testing Commands

function test {
  #@ Run all tests
  #@ Category: Testing
  cargo test $@
}

function test-unit {
  #@ Run unit tests only
  #@ Category: Testing
  cargo test --lib $@
}

function test-integration {
  #@ Run integration tests only
  #@ Category: Testing
  cargo test --test '*' $@
}

function test-coverage {
  #@ Run tests with coverage (requires cargo-tarpaulin)
  #@ Category: Testing
  if ! command -v cargo-tarpaulin &> /dev/null; then
    echo "Installing cargo-tarpaulin..."
    cargo install cargo-tarpaulin
  fi

  cargo tarpaulin --out Html --output-dir target/coverage
  echo "‚úÖ Coverage report generated in target/coverage/"
}

################################################################################
# Docker-based Build Commands (for macOS/non-Linux development)

# Helper function to detect host architecture
# Returns platform and cache suffix separated by colon (e.g., 'linux/arm64:arm64')
_detect_docker_platform() {
  local arch=$(uname -m)
  case "$arch" in
    arm64|aarch64) echo "linux/arm64:arm64" ;;
    x86_64|amd64) echo "linux/amd64:amd64" ;;
    *)
      echo "‚ö†Ô∏è  Unknown architecture: $arch, defaulting to amd64" >&2
      echo "linux/amd64:amd64"
      ;;
  esac
}

function docker-cross-build {
  #@ Cross-compile for ARM64 Linux using cross in Docker
  #@ Usage: docker-cross-build [--release]
  #@ Category: Docker Build
  local build_args="$@"

  echo "üèóÔ∏è  Cross-compiling for ARM64 in Docker container..."

  # Detect host architecture for platform selection
  IFS=':' read -r platform cache_suffix <<< "$(_detect_docker_platform)"

  # Create architecture-specific Docker volume for cargo cache (dynamic project name)
  local cache_volume="$(basename "$(pwd)")-cargo-cache-${cache_suffix}"
  docker volume create "$cache_volume" > /dev/null 2>&1 || true

  # SECURITY WARNING: Mounting /var/run/docker.sock grants full Docker daemon access,
  # effectively giving root access to the host. Required for cross tool to work with Docker.
  # See: https://docs.docker.com/engine/security/protect-access/
  docker run --rm \
    --platform "$platform" \
    -v "$(pwd):/workspace" \
    -w /workspace \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v "${cache_volume}:/cargo-cache" \
    mcr.microsoft.com/devcontainers/rust:1-bookworm \
    bash -c "
      set -e
      echo 'üì¶ Installing Docker CLI for cross...'
      apt-get update -qq && apt-get install -y -qq docker.io > /dev/null

      echo 'üì¶ Installing cross-compilation tools...'
      rustup target add aarch64-unknown-linux-musl > /dev/null

      # Check if cross is cached, otherwise install it
      if [ -f /cargo-cache/bin/cross ]; then
        echo '   Using cached cross binary'
        cp /cargo-cache/bin/cross /usr/local/cargo/bin/
        chmod +x /usr/local/cargo/bin/cross
      else
        echo '   Installing cross (this will be cached)...'
        cargo install cross --locked | grep -E '(Installing|Installed)' || true
        # Verify cross binary exists after installation
        if [ ! -f /usr/local/cargo/bin/cross ]; then
          echo '‚ùå Error: cross binary not found after installation!' >&2
          exit 1
        fi
        mkdir -p /cargo-cache/bin
        cp /usr/local/cargo/bin/cross /cargo-cache/bin/
      fi

      echo 'üî® Running cross build for ARM64...'
      cross build --target aarch64-unknown-linux-musl $build_args
      echo '‚úÖ Cross-compilation complete!'
    " && {
      echo "‚úÖ ARM64 build successful"
      echo "   Binaries in: target/aarch64-unknown-linux-musl/"
    }
}

function docker-build-deb {
  #@ Build Debian package for ARM64 in Docker container
  #@ Usage: docker-build-deb
  #@ Category: Docker Build

  echo "üèóÔ∏è  Building Debian package for ARM64 in Docker container..."

  # Detect host architecture for platform selection
  IFS=':' read -r platform cache_suffix <<< "$(_detect_docker_platform)"

  # Create architecture-specific Docker volume for cargo cache (dynamic project name)
  local cache_volume="$(basename "$(pwd)")-cargo-cache-${cache_suffix}"
  docker volume create "$cache_volume" > /dev/null 2>&1 || true

  docker run --rm \
    --platform "$platform" \
    -v "$(pwd):/workspace" \
    -w /workspace \
    -v "${cache_volume}:/cargo-cache" \
    mcr.microsoft.com/devcontainers/rust:1-bookworm \
    bash -c "
      set -e
      echo 'üì¶ Installing ARM64 cross-compilation toolchain...'
      apt-get update -qq && apt-get install -y -qq gcc-aarch64-linux-gnu > /dev/null

      echo 'üì¶ Installing build tools...'
      rustup target add aarch64-unknown-linux-musl

      # Check if cargo-deb is cached, otherwise install it
      if [ -f /cargo-cache/bin/cargo-deb ]; then
        echo '   Using cached cargo-deb binary'
        cp /cargo-cache/bin/cargo-deb /usr/local/cargo/bin/
        chmod +x /usr/local/cargo/bin/cargo-deb
      else
        echo '   Installing cargo-deb (this will be cached)...'
        cargo install cargo-deb --locked | grep -E '(Installing|Installed)' || true
        # Verify cargo-deb binary exists after installation
        if [ ! -f /usr/local/cargo/bin/cargo-deb ]; then
          echo '‚ùå Error: cargo-deb binary not found after installation!' >&2
          exit 1
        fi
        mkdir -p /cargo-cache/bin
        cp /usr/local/cargo/bin/cargo-deb /cargo-cache/bin/
      fi

      echo 'üî® Building release binary for ARM64...'
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-gnu-gcc \
      cargo build --target aarch64-unknown-linux-musl --release

      echo 'üì¶ Creating Debian package...'
      cargo deb -p halpid --target aarch64-unknown-linux-musl --no-build

      echo '‚úÖ Debian package built!'
    " && {
      echo ""
      echo "‚úÖ Debian package built successfully!"
      local deb_file=$(ls -t target/aarch64-unknown-linux-musl/debian/*.deb 2>/dev/null | head -1)
      if [ -n "$deb_file" ]; then
        echo "   Package: $deb_file"
        ls -lh "$deb_file"
      fi
    }
}

################################################################################
# Package Management Commands

function build-deb {
  #@ Build Debian package (native)
  #@ Category: Package Management
  echo "üèóÔ∏è Building Debian package..."

  if ! command -v cargo-deb &> /dev/null; then
    echo "Installing cargo-deb..."
    cargo install cargo-deb
  fi

  cargo deb -p halpid
  echo "‚úÖ Debian package built successfully"
}

function cross-build-deb {
  #@ Build Debian package for ARM64 using cross
  #@ Category: Package Management
  echo "üèóÔ∏è Building ARM64 Debian package..."

  # First build release binary for ARM64
  cross-build --release

  # Then build package
  if ! command -v cargo-deb &> /dev/null; then
    echo "Installing cargo-deb..."
    cargo install cargo-deb
  fi

  cargo deb -p halpid --target aarch64-unknown-linux-musl --no-build
  echo "‚úÖ ARM64 Debian package built successfully"
}

################################################################################
# Development Utilities

function run-daemon {
  #@ Run daemon in development mode
  #@ Category: Development Utilities
  cargo run -p halpid
}

function clean-all {
  #@ Deep clean (cargo + artifacts + packages)
  #@ Category: Development Utilities
  clean
  rm -rf target/debian
  rm -rf target/coverage
  echo "‚úÖ Deep clean complete"
}

function bumpversion {
  #@ Bump version using bumpversion tool
  #@ Usage: bumpversion [patch|minor|major] or bumpversion --new-version X.Y.Z patch
  #@ Category: Development Utilities
  command bumpversion "$@"
}

function version {
  #@ Show current project version
  #@ Category: Development Utilities
  cat VERSION
}

function build-release {
  #@ Build release artifacts for ARM64
  #@ Category: Development Utilities
  echo "üèóÔ∏è Building release artifacts for ARM64..."
  cross-build --release
  echo "‚úÖ Release artifacts built in target/aarch64-unknown-linux-musl/release/"
}

function hooks-install {
  #@ Install pre-commit hooks using lefthook
  #@ Category: Development Utilities
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook install
  echo "‚úÖ Pre-commit hooks installed"
}

function hooks-run {
  #@ Run pre-commit hooks manually
  #@ Category: Development Utilities
  if ! command -v lefthook &> /dev/null; then
    echo "Error: lefthook not found. Install with: brew install lefthook"
    exit 1
  fi
  lefthook run pre-commit
}

################################################################################
# CI/CD Commands

function ci-check {
  #@ Run CI verification checks
  #@ Category: CI/CD
  echo "üîç Running CI checks..."
  check
  check-format
  test
  echo "‚úÖ All CI checks passed"
}

function ci-build {
  #@ Full CI build pipeline
  #@ Category: CI/CD
  echo "üöÄ Running full CI build pipeline..."
  ci-check
  build --release
  echo "‚úÖ CI build complete"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-30s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
}

################################################################################
# Main dispatcher

# If no arguments provided, show help
if [ $# -eq 0 ]; then
  help
  exit 0
fi

# Get the command name
cmd=$1
shift

# Check if function exists
if declare -f "$cmd" > /dev/null; then
  # Run the command with timing
  TIMEFORMAT=$'\nTask completed in %3lR'
  time "$cmd" "$@"
else
  echo "Error: Unknown command '$cmd'"
  echo
  echo "Run './run help' to see available commands"
  exit 1
fi
